package v1alpha1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
)

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// BGPConfiguration is the Schema for the bgpconfigurations API
type BGPConfiguration struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   BGPConfigurationSpec   `json:"spec,omitempty"`
	Status BGPConfigurationStatus `json:"status,omitempty"`
}

// BGPConfigurationSpec defines the desired state of BGPConfiguration
type BGPConfigurationSpec struct {
	// Global BGP configuration
	// +kubebuilder:pruning:PreserveUnknownFields
	Global           *GlobalSpec `json:"global,omitempty"`
	// TODO: Add other fields as RawExtension for now
}

// GlobalSpec mirrors the gobgpapi.Global message for CRD configuration
type GlobalSpec struct {
	ASN                     uint32                  `json:"asn,omitempty"`
	RouterID                string                  `json:"routerID,omitempty"`
	ListenPort              int32                   `json:"listenPort,omitempty"`
	ListenAddresses         []string                `json:"listenAddresses,omitempty"`
	Families                []uint32                `json:"families,omitempty"`
	UseMultiplePaths        bool                    `json:"useMultiplePaths,omitempty"`
	RouteSelectionOptions   *RouteSelectionOptions  `json:"routeSelectionOptions,omitempty"`
	DefaultRouteDistance    *DefaultRouteDistance   `json:"defaultRouteDistance,omitempty"`
	Confederation           *Confederation          `json:"confederation,omitempty"`
	GracefulRestart         *GracefulRestart        `json:"gracefulRestart,omitempty"`
	ApplyPolicy             *ApplyPolicy            `json:"applyPolicy,omitempty"`
	BindToDevice            string                  `json:"bindToDevice,omitempty"`
}

// RouteSelectionOptions mirrors gobgpapi.RouteSelectionOptionsConfig
type RouteSelectionOptions struct {
	AlwaysCompareMed        bool `json:"alwaysCompareMed,omitempty"`
	IgnoreASPathLength      bool `json:"ignoreASPathLength,omitempty"`
	ExternalCompareRouterID bool `json:"externalCompareRouterID,omitempty"`
	AdvertiseInactiveRoutes bool `json:"advertiseInactiveRoutes,omitempty"`
	EnableAIGP              bool `json:"enableAIGP,omitempty"`
	IgnoreNextHopIGPMetric  bool `json:"ignoreNextHopIGPMetric,omitempty"`
	DisableBestPathSelection bool `json:"disableBestPathSelection,omitempty"`
}

// DefaultRouteDistance mirrors gobgpapi.DefaultRouteDistance
type DefaultRouteDistance struct {
	ExternalRouteDistance uint32 `json:"externalRouteDistance,omitempty"`
	InternalRouteDistance uint32 `json:"internalRouteDistance,omitempty"`
}

// Confederation mirrors gobgpapi.Confederation
type Confederation struct {
	Enabled      bool     `json:"enabled,omitempty"`
	Identifier   uint32   `json:"identifier,omitempty"`
	MemberASList []uint32 `json:"memberASList,omitempty"`
}

// GracefulRestart mirrors gobgpapi.GracefulRestart
type GracefulRestart struct {
	Enabled          bool   `json:"enabled,omitempty"`
	RestartTime      uint32 `json:"restartTime,omitempty"`
	HelperOnly       bool   `json:"helperOnly,omitempty"`
	DeferralTime     uint32 `json:"deferralTime,omitempty"`
	NotificationEnabled bool `json:"notificationEnabled,omitempty"`
	LonglivedEnabled bool   `json:"longlivedEnabled,omitempty"`
	StaleRoutesTime  uint32 `json:"staleRoutesTime,omitempty"`
	PeerRestartTime  uint32 `json:"peerRestartTime,omitempty"`
	PeerRestarting   bool   `json:"peerRestarting,omitempty"`
	LocalRestarting  bool   `json:"localRestarting,omitempty"`
	Mode             string `json:"mode,omitempty"`
}

// ApplyPolicy mirrors gobgpapi.ApplyPolicy
type ApplyPolicy struct {
	InPolicy    string `json:"inPolicy,omitempty"`
	ExportPolicy string `json:"exportPolicy,omitempty"`
	ImportPolicy string `json:"importPolicy,omitempty"`
}

// BGPConfigurationStatus defines the observed state of BGPConfiguration
type BGPConfigurationStatus struct {
	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
	// Important: Run "make generate" to regenerate code after modifying this file
	ObservedGeneration int64 `json:"observedGeneration,omitempty"`
}

// +kubebuilder:object:root=true

// BGPConfigurationList contains a list of BGPConfiguration
type BGPConfigurationList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []BGPConfiguration `json:"items"`
}